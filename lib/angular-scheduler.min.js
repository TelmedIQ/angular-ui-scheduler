/*! angular-schedule.js - v0.0.1 - 2014-02-26 */"use strict";angular.module("AngularScheduler",["Timezones"]).constant("$timezones.definitions.location","/bower_components/angular-timezones/tz/data").constant("scheduler_partial","/lib/angular-scheduler.html").factory("SchedulerInit",["$filter","$timezones","LoadLookupValues","SetDefaults","CreateObject",function(a,b,c,d,e){return function(a){var f=a.scope;return f.removeZonesReady&&f.removeZonesReady(),f.removeZonesReady=f.$on("zonesReady",function(){var a;if(f.timeZones=JSON.parse(localStorage.zones),f.current_timezone=b.getLocal(),!$.isEmptyObject(f.current_timezone)&&f.current_timezone.name)for(a=0;a<f.timeZones.length;a++)f.timeZones[a].name===f.current_timezone.name&&(f.schedulerTimeZone=f.timeZones[a]);else f.schedulerTimeZone=null}),b.getZoneList(f),f.scheduleTimeChange=function(){if(f.schedulerStartDt){f.resetStartDate();try{var a=f.schedulerStartDt+"T"+f.schedulerStartHour+":"+f.schedulerStartMinute+":"+f.schedulerStartSecond+".000Z";f.schedulerUTCTime=b.toUTC(a,f.schedulerTimeZone.name).toISOString()}catch(c){f.startDateError("Provide a valid start date and time")}}else f.schedulerUTCTime=""},f.scheduleRepeatChange=function(){f.schedulerFrequency&&""!==f.schedulerFrequency.value&&"none"!==f.schedulerFrequency.value?(f.schedulerInterval=1,f.schedulerShowInterval=!0,f.schedulerIntervalLabel=f.schedulerFrequency.intervalLabel):(f.schedulerShowInterval=!1,f.schedulerEnd=f.endOptions[0])},f.showCalendar=function(a){$("#"+a).focus()},f.monthlyRepeatChange=function(){$("#monthDay").spinner("day"!==f.monthlyRepeatOption?"disable":"enable")},f.yearlyRepeatChange=function(){$("#yearlyRepeatDay").spinner("month"!==f.yearlyRepeatOption?"disable":"enable")},f.setWeekday=function(a){var b=f.weekDays.indexOf(a);b>=0?f.weekDays.splice(a,1):f.weekDays.push(a)},f.startDateError=function(a){f.scheduler_form&&(f.scheduler_form_schedulerStartDt_error=a,f.scheduler_form.schedulerStartDt.$pristine=!1,f.scheduler_form.schedulerStartDt.$dirty=!0,$("#schedulerStartDt").removeClass("ng-pristine").removeClass("ng-valid").removeClass("ng-valid-custom-error").addClass("ng-dirty").addClass("ng-invalid").addClass("ng-invalid-custom-error"))},f.resetStartDate=function(){f.scheduler_form&&(f.scheduler_form_schedulerStartDt_error="",f.scheduler_form.schedulerStartDt.$setValidity("custom-error",!0),f.scheduler_form.schedulerStartDt.$setPristine())},c(f),d(f),f.scheduleTimeChange(),e(f)}}]).factory("CreateObject",["$filter","GetRule","Inject","SetDefaults","$timezones",function(a,b,c,d,e){return function(f){var g=function(){this.scope=f,this.getOptions=function(){var a={};return a.startDate=this.scope.schedulerUTCTime,a.frequency=this.scope.schedulerFrequency.value,a.interval=this.scope.schedulerInterval,"after"===this.scope.schedulerEnd.value&&(a.occurrenceCount=this.scope.schedulerOccurrenceCount),"on"===this.scope.schedulerEnd.value&&(a.endDate=this.scope.schedulerEndDt),"weekly"===this.scope.schedulerFrequency.value?a.weekDays=this.scope.weekDays:"yearly"===this.scope.schedulerFrequency.value?"month"===this.scope.yearlyRepeatOption?(a.month=this.scope.yearlyMonth.value,a.monthDay=this.scope.yearlyMonthDay):(a.setOccurrence=this.scope.yearlyOccurrence.value,a.weekDays=this.scope.yearlyWeekDay.value,a.month=this.scope.yearlyOtherMonth.value):"monthly"===this.scope.schedulerFrequency.value&&("day"===this.scope.monthlyRepeatOption?a.monthDay=this.scope.monthDay:(a.setOccurrence=this.scope.monthlyOccurrence.value,a.weekDays=this.scope.monthlyWeekDay.value)),a},this.clearErrors=function(){this.scope.scheduler_weekDays_error=!1,this.scope.scheduler_endDt_error=!1,this.scope.resetStartDate(),this.scope.scheduler_endDt_error=!1,this.scope.scheduler_form.schedulerEndDt.$setValidity("custom-error",!0),this.scope.scheduler_form.schedulerEndDt.$setPristine(),this.scope.scheduler_form.$setPristine()},this.isValid=function(){var b,c,d,g,h=!0;return this.clearErrors(),"weekly"===this.scope.schedulerFrequency.value&&0===f.weekDays.length&&(this.scope.scheduler_weekDays_error=!0,h=!1),this.scope.scheduler_form.scheduleName.$valid||(this.scope.scheduler_form.scheduleName.$dirty=!0,$("#scheduleName").addClass("ng-dirty"),h=!1),"on"===this.scope.schedulerEnd.value&&(/^\d{4}-\d{2}-\d{2}$/.test(this.scope.schedulerEndDt)||(this.scope.scheduler_form.schedulerEndDt.$pristine=!1,this.scope.scheduler_form.schedulerEndDt.$dirty=!0,$("#schedulerEndDt").removeClass("ng-pristine").removeClass("ng-valid").removeClass("ng-valid-custom-error").addClass("ng-dirty").addClass("ng-invalid").addClass("ng-invalid-custom-error"),this.scope.scheduler_endDt_error=!0,h=!1)),this.scope.schedulerUTCTime?(b=new Date(this.scope.schedulerUTCTime),c=new Date,d=c.getFullYear()+"-"+a("schZeroPad")(c.getMonth()+1,2)+"-"+a("schZeroPad")(c.getDate(),2)+"T"+a("schZeroPad")(c.getHours(),2)+":"+a("schZeroPad")(c.getMinutes(),2)+":"+a("schZeroPad")(c.getSeconds(),2)+".000Z",g=e.toUTC(d,this.scope.schedulerTimeZone.name),g.getTime()>=b.getTime()&&(h=!1,this.scope.startDateError("Start date and time must be in the future"))):(f.startDateError("Provide a valid start date and time"),h=!1),h},this.getRule=function(){var a=this.getOptions();return b(a)},this.getValue=function(){var a=this.getRule(),b=this.getOptions();return{name:f.scheduleName,rrule:a.toString(),options:b}},this.inject=function(a,b){return c({scope:this.scope,target:a,buttons:b})},this.clear=function(){this.clearErrors(),this.scope.scheduler_form.scheduleName.$setPristine(),d(this.scope)}};return new g}}]).factory("Inject",["scheduler_partial","$compile","$http","$log",function(a,b,c,d){return function(e){var f=e.scope,g=e.target,h=e.buttons;f.removeHtmlReady&&f.removeHtmlReady(),f.removeHtmlReady=f.$on("htmlReady",function(a,c){var d=angular.isObject(g)?g:angular.element(document.getElementById(g));d.html(c),b(d)(f),h&&$("#scheduler-buttons").show()}),c({method:"GET",url:a}).success(function(a){f.$emit("htmlReady",a)}).error(function(b,c){d.error("Error calling "+a+". "+c)})}}]).factory("GetRule",["$log",function(a){return function(b){var c,d=b.startDate,e=b.frequency,f=b.interval,g=b.occurrenceCount,h=b.endDate,i=b.month,j=b.monthDay,k=b.weekDays,l=b.setOccurrence,m={};if(angular.isDate(d))m.dtstart=d;else try{m.dtstart=new Date(d)}catch(n){a.error("Date conversion failed. Attempted to convert "+d+" to Date. "+n.message)}if(e&&"none"!==e){if(m.freq=RRule[e.toUpperCase()],m.interval=f,k&&"string"==typeof k&&(m.byweekday=RRule[k.toUpperCase()]),k&&angular.isArray(k))for(m.byweekday=[],c=0;c<k.length;c++)m.byweekday.push(RRule[k[c].toUpperCase()]);if(void 0!==l&&null!==l&&(m.bysetpos=l),i&&(m.bymonth=i),j&&(m.bymonthday=j),g)m.count=g;else if(h)if(angular.isDate(h))m.until=h;else try{m.until=new Date(h)}catch(n){a.error("Date conversion failed. Attempted to convert "+h+" to Date. "+n.message)}}else m.freq=RRule.DAILY,m.interval=1,m.count=1;return new RRule(m)}}]).factory("SetDefaults",["$filter",function(a){return function(b){var c=new Date,d=a("schZeroPad")(c.getMonth()+1,2),e=a("schZeroPad")(c.getDate(),2),f=c.getFullYear()+"-"+d+"-"+e;b.scheduleName="",b.weekDays=[],b.schedulerStartHour="00",b.schedulerStartMinute="00",b.schedulerStartSecond="00",b.schedulerStartDt=f,b.schedulerFrequency=b.frequencyOptions[0],b.schedulerShowEvery=!1,b.schedulerEnd=b.endOptions[0],b.schedulerOccurrenceCount=1,b.monthlyRepeatOption="day",b.monthDay=1,b.monthlyOccurrence=b.occurrences[0],b.monthlyWeekDay=b.weekdays[0],b.yearlyRepeatOption="month",b.yearlyMonth=b.months[0],b.yearlyMonthDay=1,b.yearlyWeekDay=b.weekdays[0],b.yearlyOtherMonth=b.months[0],b.yearlyRepeatOccurrence=b.occurrences[0]}}]).factory("LoadLookupValues",[function(){return function(a){a.frequencyOptions=[{name:"None (run once)",value:"none",intervalLabel:""},{name:"Minutely",value:"minutely",intervalLabel:"minutes"},{name:"Hourly",value:"hourly",intervalLabel:"hours"},{name:"Daily",value:"daily",intervalLabel:"days"},{name:"Weekly",value:"weekly",intervalLabel:"weeks"},{name:"Monthly",value:"monthly",intervalLabel:"months"},{name:"Yearly",value:"yearly",intervalLabel:"years"}],a.endOptions=[{name:"Never",value:"never"},{name:"After",value:"after"},{name:"On Date",value:"on"}],a.occurrences=[{name:"first",value:1},{name:"second",value:2},{name:"third",value:3},{name:"fourth",value:4},{name:"last",value:-1}],a.weekdays=[{name:"Sunday",value:"su"},{name:"Monday",value:"mo"},{name:"Tueday",value:"tu"},{name:"Wednesday",value:"we"},{name:"Thursday",value:"th"},{name:"Friday",value:"fr"},{name:"Saturday",value:"sa"},{name:"Day",value:["mo","tu","we","th","fr","sa","su"]},{name:"Weekday",value:["mo","tu","we","th","fr"]},{name:"Weekend day",value:["sa","su"]}],a.months=[{name:"January",value:1},{name:"February",value:2},{name:"March",value:3},{name:"April",value:4},{name:"May",value:5},{name:"June",value:6},{name:"July",value:7},{name:"August",value:8},{name:"September",value:9},{name:"October",value:10},{name:"November",value:11},{name:"December",value:12}]}}]).filter("schZeroPad",[function(){return function(a,b){var c=(Math.pow(10,b)+"").replace(/^1/,"")+(a+"").trim();return c.substr(c.length-b)}}]).directive("schTooltip",[function(){return{link:function(a,b,c){var d=c.placement?c.placement:"top";$(b).tooltip({html:!0,placement:d,title:c.afTooltip,trigger:"hover",container:"body"})}}}]).directive("schDatePicker",[function(){return{require:"ngModel",link:function(a,b,c){var d={},e=c.ngModel,f=new Date;d.dateFormat=c.dateFormat||"yy-mm-dd",d.defaultDate=a[e],d.minDate=c.minToday?f:null,d.maxDate=c.maxDate?new Date(c("maxDate")):null,d.changeMonth="false"===c.changeMonth?!1:!0,d.changeYear="false"===c.changeYear?!1:!0,$(b).datepicker(d)}}}]).directive("schSpinner",["$filter",function(a){return{require:"ngModel",link:function(b,c,d,e){var f=d.schSpinner,g=d.zeroPad;$(c).spinner({stop:function(){g?(b[d.ngModel]=a("schZeroPad")($(this).val(),g),$(this).val(b[d.ngModel])):b[d.ngModel]=$(this).spinner("value"),d.ngChange&&b.$apply(b[d.ngChange])},spin:function(){b[f].$setDirty(),e.$dirty=!0,e.$pristine=!1,b.$$phase||b.$digest()}})}}}]);